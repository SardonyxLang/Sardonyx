#!/usr/bin/ruby
require "sdx/compiler/parser"
require "sdx/compiler/compiler"
require "sdx/vm/vm"
require "stringio"
require "readline"

if (ENV.fetch("SDX_PATH", "").split ":") == []
    puts "\x1b[0;33mLooks like you don't have anything in your SDX_PATH! You should install the stdlib at https://github.com/SardonyxLang/SardonyxStd.\x1b[0;0m"
end

if ARGV.size == 1
    path = [(File.expand_path File.dirname ARGV[0]), *(ENV.fetch("SDX_PATH", "").split ":")]
    code = File.read ARGV[0]
    lexed, lines = Parser::Lexer.lex code
    ast = Parser::Parser.parse lexed, path, lines
    if State::state == :ok
        bc = Compiler::Compiler.compile ast
        vm = VM.new StringIO.new bc
        vm.interpret
    end
else
    path = [(File.expand_path Dir.pwd), *(ENV.fetch("SDX_PATH", "").split ":")]
    vm = VM.new StringIO.new ""
    puts "Sardonyx v0.3.1"
    puts "Type :help for help, or :exit to exit"
    loop do
        begin
            code = Readline.readline("> ", true)
        rescue Interrupt
            puts "^C"
            code = ""
        end
        unless code
            puts ":exit"
            exit 0
        end
        case code
        when ":exit"
            exit 0
        when ":help"
            puts "See sardonyxlang.github.io/docs for documentation - for now, try entering \"5 + 5\""
        else
            lexed, lines = Parser::Lexer.lex code
            ast = Parser::Parser.parse lexed, path, lines
            if State::state == :ok
                bc = Compiler::Compiler.compile ast
                vm.bc_io = StringIO.new bc
                vm.byte_pos = 0
                vm.interpret false
                val = vm.stack[-1]
                vm.clear
                if val
                    puts vm.stringify val
                end
            end
        end
    end
end
